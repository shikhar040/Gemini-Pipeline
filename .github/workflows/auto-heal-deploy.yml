name: AI Auto-Heal and Deploy to Netlify

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  ai-auto-heal:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: DEBUG - Show all problematic files
      run: |
        echo "üîç SCANNING FOR PROBLEMATIC FILES:"
        echo "Files with spaces:"
        find . -name "* *" | head -10
        echo "Files with wrong extensions:"
        find . -name "*.jx" -o -name "*.htm" -o -name "*.PY" | head -10
        echo "Files with special chars:"
        find . -name "*@*" -o -name "*#*" -o -name "*\$*" | head -10

    - name: Auto-fix critical file issues
      run: |
        echo "üö® STARTING AUTO-FIX PROCESS..."
        
        # Fix index.htm to index.html (CRITICAL)
        if [ -f "public/index.htm" ]; then
          echo "üõ†Ô∏è FIXING: public/index.htm ‚Üí public/index.html"
          mv "public/index.htm" "public/index.html"
        fi
        
        # Fix files with spaces
        echo "üõ†Ô∏è Fixing files with spaces..."
        find . -name "* *" | while read file; do
          new_name=$(echo "$file" | tr " " "-" | tr '[:upper:]' '[:lower:]')
          if [ "$file" != "$new_name" ]; then
            echo "FIXING: $file ‚Üí $new_name"
            mv "$file" "$new_name"
          fi
        done
        
        # Fix wrong extensions
        echo "üõ†Ô∏è Fixing file extensions..."
        find . -name "*.jx" -exec bash -c 'echo "FIXING: {} ‚Üí {}.js" && mv "{}" "{}.js"' \;
        find . -name "*.htm" ! -name "*.html" -exec bash -c 'echo "FIXING: {} ‚Üí {}l" && mv "{}" "{}l"' \;
        find . -name "*.PY" -exec bash -c 'echo "FIXING: {} ‚Üí {}.py" && mv "{}" "{}.py" && mv "{}.py" "$(echo {} | sed "s/.PY$/.py/")"' \;

    - name: Run Gemini AI Auto-Healer
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "ü§ñ RUNNING GEMINI AI..."
        if [ -f "src/gemini_healer.py" ]; then
          python src/gemini_healer.py --path . --api-key "$GEMINI_API_KEY" || echo "AI completed"
        fi

    - name: DEBUG - Show final result
      run: |
        echo "‚úÖ FINAL FILE CHECK:"
        echo "All files in public/:"
        ls -la public/
        echo "Git status:"
        git status

  deploy:
    runs-on: ubuntu-latest
    needs: ai-auto-heal
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './public'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "AI Auto-heal test"
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}